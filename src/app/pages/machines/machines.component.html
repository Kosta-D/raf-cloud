<div class="machines">
  <h2>Pretraga mašina</h2>

  <!-- Ako nema dozvolu za pretragu -->
  <div *ngIf="!auth.hasPermission('SEARCH_MACHINE')" class="no-access">
    Nemate dozvolu da pretražujete mašine.
  </div>

  <!-- Forma za pretragu -->
  <form
    *ngIf="auth.hasPermission('SEARCH_MACHINE')"
    (ngSubmit)="search()"
    class="filters">

    <div class="row">
      <label>
        Naziv:
        <input
          type="text"
          [(ngModel)]="name"
          name="name"
          placeholder="npr. Alpha" />
      </label>

      <label>
        Tip:
        <input
          type="text"
          [(ngModel)]="type"
          name="type"
          placeholder="npr. Database" />
      </label>

      <div class="states">
        <span>Stanje:</span>
        <label *ngFor="let s of stateChoices" class="state-item">
          <input
            type="checkbox"
            [(ngModel)]="stateSelection[s]"
            name="state_{{ s }}" />
          {{ getStateLabel(s) }}
        </label>
      </div>
    </div>

    <div class="row">
      <label>
        Od datuma:
        <input
          type="date"
          [(ngModel)]="from"
          name="from" />
      </label>

      <label>
        Do datuma:
        <input
          type="date"
          [(ngModel)]="to"
          name="to" />
      </label>
    </div>

    <div class="actions">
      <button type="submit" class="btn btn-primary">
        Pretraži
      </button>
      <button
        type="button"
        class="btn btn-secondary"
        (click)="clearFilters()">
        Očisti filtere
      </button>
    </div>
  </form>

  <!-- Rezultati -->
  <div *ngIf="auth.hasPermission('SEARCH_MACHINE')">
    <table class="table table-striped" *ngIf="results?.length; else noResults">
      <thead>
      <tr>
        <th>Naziv</th>
        <th>Tip</th>
        <th>Opis</th>
        <th>Vlasnik (ID)</th>
        <th>Kreirana</th>
        <th>Stanje</th>
        <th class="text-end">Akcije</th>
      </tr>
      </thead>

      <tbody>
      <tr *ngFor="let m of results">
        <td>{{ m.name }}</td>
        <td>{{ m.type || '—' }}</td>
        <td>{{ m.description || '—' }}</td>
        <td>{{ m.ownerUserId }}</td>
        <td>{{ m.createdAt | date:'short' }}</td>
        <td>{{ getStateLabel(m.state) }}</td>

        <td class="text-end">

          <!-- START -->
          <button
            class="btn btn-sm btn-success me-1"
            *ngIf="auth.hasPermission('START_MACHINE')"
            [disabled]="m.state !== 'STOPPED'"
            (click)="start(m)">
            Start
          </button>

          <!-- STOP -->
          <button
            class="btn btn-sm btn-warning me-1"
            *ngIf="auth.hasPermission('STOP_MACHINE')"
            [disabled]="m.state !== 'RUNNING'"
            (click)="stop(m)">
            Stop
          </button>

          <!-- RESTART -->
          <button
            class="btn btn-sm btn-info me-1"
            *ngIf="auth.hasPermission('RESTART_MACHINE')"
            [disabled]="m.state !== 'RUNNING'"
            (click)="restart(m)">
            Restart
          </button>

          <!-- DESTROY -->
          <button
            class="btn btn-sm btn-outline-danger"
            *ngIf="auth.hasPermission('DESTROY_MACHINE')"
            (click)="destroy(m)">
            Destroy
          </button>

        </td>
      </tr>
      </tbody>
    </table>

    <ng-template #noResults>
      <div class="no-results">
        Nema rezultata za zadate filtere.
      </div>
    </ng-template>
  </div>
</div>
